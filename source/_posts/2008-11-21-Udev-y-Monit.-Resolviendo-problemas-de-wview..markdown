---
layout: post
title: Udev y Monit. Resolviendo problemas de wview.
categories: []
permalink: /archives/36-Udev-y-Monit.-Resolviendo-problemas-de-wview..html
s9y_link: http://xarx.es/deries/archives/36-Udev-y-Monit.-Resolviendo-problemas-de-wview..html
date: 2008-11-21 16:59:00.000000000 +01:00
---
<br />
<div align="left">Wview es un software de wviewweather.com que permite obtener los datos de varios tipos de estaciones meteorológicas desde linux y genera una web estática actualizada desde los datos de la estación. También puede almacenar los datos en BD y enviar informes a diferentes servicios (AWEKAS, CWOP y <br />
          Weather Underground). Por ejemplo: <a href="http://www.castello.es/archivos/598/img/index.html" title="Planetari de Castelló. Estación Meteorológica.">Estación meteorológica en el Planetari de Castelló</a></div><div align="left"></div><div align="left"></div><div align="left"></div><div align="left"></div><p /><div align="left">Bien pues después de utilizarlo un tiempo aparecen 2 problemas esenciales para mantenerlo online:</div><div align="left"></div><div align="left">1-. La estación está conectada a través de USB pero con un conversor cp2101. El problema es que algunas veces el sistema se reinicia pero enlazándose en /dev/ttyUSB1 en vez de /dev/ttyUSB0 que es el estándar.</div><div align="left"></div><div align="left"></div><div align="left">2-. Alguna vez muere alguno de los procesos (wviewd o htmlgend) y deja de actualizarse la web. El origen todavía no lo tengo claro. Pero parece que wvpmon, que debería monitorizar los procesos y reiniciar el que falle, no lo hace correctamente.</div><p /><div align="left"></div><div align="left"><b></b></div><div align="left"></div><div align="left"><b>Soluciones:</b></div><div align="left">1-. para evitar que haya problemas con el cambio de puerto USB podemos incluir una nueva regla UDEV. Haremos que nuestro software apunte a un puerto &quot;ficticio&quot; wviewUSB y con la regla nueva crearemos un enlace simbólico de este puerto al que esté funcionando. Además podemos ejecutar un script para hacer reiniciarse a los procesos de wview...</div><blockquote># Regla udev para que cuando la estacion cambie de ttyUSB0 a 1 o<br />#  viceversa se actualice un symlink de wviewUSB --&gt; ttyUSB? (0 o 1)<br />#  y se ejecute un script que reinicie wview. (Lo sgte todo en una linea)<br /><br />SUBSYSTEMS==&quot;tty&quot;, KERNEL==&quot;ttyUSB?&quot;, NAME=&quot;%k&quot;, SYMLINK+=&quot;wviewUSB&quot;, RUN+=&quot;/etc/init.d/wview.udev&quot;</blockquote><div align="left"></div><div align="left">2-. para reiniciar los procesos podríamos utilizar cron junto con algún script específico. Pero también podemos utilizar monit. Éste es un monitor de &quot;eventos&quot; que nos permite realizar acciones por ejemplo si el disco, la cpu o la ram están muy ocupadas o, como en este caso, si no se han generado los archivos de la estación.</div><div align="left">Para ponerlo en marcha instalamos el paquete (sudo apt-get install monit) y deberemos editar los archivos /etc/default/monit (cambiar de startup=0 a startup=1) y /etc/monit/monitrc, que es donde realmente haremos los cambios:</div><div align="left"></div><p /><blockquote># habilitar el servidor web interno de monit visible en http://localhost:2812/<br />set httpd port 2812 and<br />     use address localhost  # only accept connection from localhost. without: all<br />     allow localhost        # allow localhost to connect to the server and<br />     allow admin:monit      # require user 'admin' with password 'monit'<br /><br /># incluir las reglas de monitorizacion y sus efectos<br />check file Current.htm with path /usr/local/var/wview/img/Current.htm<br />   if timestamp &gt; 20  minute then exec &quot;/etc/init.d/wview.monit&quot;<br /><br />check file tempdaycomp.png with path /usr/local/var/wview/img/tempdaycomp.png<br />   if timestamp &gt; 20  minute then exec &quot;/etc/init.d/wview.monit&quot;</blockquote><p><br />
Con esto conseguimos que se ejecute el script wview.monit si en 20 minutos no se ha actualizado una de las páginas web (Current.htm) o si no se ha actualizado uno de los gráficos. En teoría el archivo htm debería actualizarse una vez cada 5min y el gráfico una vez cada 10. Si no ocurre deberíamos hacer o bien que wview se reiniciase (wview restart) o bien que se reinicie el sistema completo. Incluso podríamos hacer que si la espera es de 20min que se reinicie wview y si pasa de 40min que se reinicie el equipo.</p><p />
